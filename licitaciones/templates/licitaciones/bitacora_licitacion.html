{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Bit√°cora de Licitaci√≥n</title>
    <link rel="stylesheet" href="{% static 'licitaciones/css/gestion_licitaciones.css' %}">
    <link rel="stylesheet" href="{% static 'licitaciones/css/bitacora_licitacion.css' %}?v=1.1">
</head>
<body>
    {% include 'licitaciones/sidebar.html' %}
    <div class="main-content m-sidebar">
        <div class="bitacora-container">
            <div class="bitacora-header">
                <h1 class="bitacora-titulo">üìã BIT√ÅCORA DE LICITACI√ìN</h1>                <div class="bitacora-info">
                    <div class="info-item" data-tipo="pedido">
                        <span class="info-label">N¬∞ Pedido:</span>
                        <span class="info-value">{{ licitacion.numero_pedido }}</span>
                    </div>
                    <div class="info-item" data-tipo="proyecto">
                        <span class="info-label">Proyecto:</span>
                        <span class="info-value">{{ licitacion.iniciativa }}</span>
                    </div>
                    <div class="info-item" data-tipo="tipo-licitacion">
                        <span class="info-label">Tipo de Licitaci√≥n:</span>
                        <span class="info-value">{{ licitacion.tipo_licitacion.nombre|default:'No especificado' }}</span>
                    </div>
                    <div class="info-item" data-tipo="estado">
                        <span class="info-label">Estado Actual:</span>
                        <span class="info-value estado-{{ licitacion.estado_fk.nombre|slugify|default:'sin-estado' }}">
                            {{ licitacion.estado_fk.nombre|default:'Sin estado' }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Panel integrado para agregar observaci√≥n (solo operadores) -->
            {% if licitacion.estado_fk.nombre|lower == 'en curso' %}
            <div class="bitacora-panel-operador" id="panelObservacionOperador">
                <div class="panel-header">
                    <h3 class="panel-titulo">
                        <span class="panel-icono">‚úçÔ∏è</span>
                        Agregar Nueva Observaci√≥n
                    </h3>
                    <button type="button" class="panel-toggle" id="togglePanelObservacion" title="Minimizar/Expandir">
                        <span class="toggle-icono">‚ñº</span>
                    </button>
                </div>
                
                <div class="panel-contenido" id="contenidoPanelObservacion">
                    <form id="formObservacionBitacora" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="licitacion_id" value="{{ licitacion.id }}">
                        
                        <!-- Informaci√≥n de etapa actual -->
                        <div class="etapa-actual-info">
                            <div class="etapa-label">Etapa actual:</div>
                            <div class="etapa-display">
                                <span id="nombreEtapaActual" class="etapa-nombre" data-etapa-id="{{ licitacion.etapa_fk.id }}">
                                    {{ licitacion.etapa_fk.nombre|default:'Sin etapa' }}
                                </span>
                                <button type="button" id="btnRetrocederEtapa" class="btn-retroceder-etapa hidden" title="Retroceder a etapa anterior">
                                    <span class="btn-flecha">‚Üê</span>
                                    <span class="btn-texto">Retroceder</span>
                                </button>
                                <button type="button" id="btnAvanzarEtapa" class="btn-avanzar-etapa hidden" title="Avanzar a siguiente etapa">
                                    <span class="btn-texto">Avanzar</span>
                                    <span class="btn-flecha">‚Üí</span>
                                </button>
                            </div>
                        </div>
                        
                        <input type="hidden" id="accionEtapa" name="accion_etapa" value="none">

                        <div id="fechasImportantesContainer" class="fechas-importantes-container hidden" style="margin-bottom: 50px;">
                            <h3 class="section-title" style="cursor: pointer;">
                                <span class="section-icon">üìÖ</span>
                                Fechas importantes
                            </h3>
                            <label for="cierrePreguntasInput" class="campo-label">
                                <span class="field-icon"></span>
                                Cierre de preguntas
                            </label>
                            <input type="date" name="fecha_cierre_preguntas_publicacionportal" id="cierrePreguntasInput" class="campoEtapa" value="{{ licitacion.fecha_cierre_preguntas_publicacionportal|date:"Y-m-d"|default:'' }}">
                            </input>
                            <label for="respuestaInput" class="campo-label">
                                <span class="field-icon"></span>
                                Respuesta
                            </label>
                            <input type="date" name="fecha_respuesta_publicacionportal" id="respuestaInput" class="campoEtapa" value="{{ licitacion.fecha_respuesta_publicacionportal|date:"Y-m-d"|default:'' }}">
                            </input>
                            <label for="visitaTerrenoInput" class="campo-label">
                                <span class="field-icon"></span>
                                Visita a terreno
                            </label>
                            <input type="date" name="fecha_visita_terreno_publicacionportal" id="visitaTerrenoInput" class="campoEtapa"  value="{{ licitacion.fecha_visita_terreno_publicacionportal|date:"Y-m-d"|default:'' }}">
                            </input>
                            <label for="cierreOfertaInput" class="campo-label">
                                <span class="field-icon"></span>
                                Cierre de oferta
                            </label>
                            <input type="date" name="fecha_cierre_oferta_publicacionportal" id="cierreOfertaInput" class="campoEtapa"  value="{{ licitacion.fecha_cierre_oferta_publicacionportal|date:"Y-m-d"|default:'' }}">
                            </input>
                            <label for="aperturaTecnicaInput" class="campo-label">
                                <span class="field-icon"></span>
                                Apertura t√©cnica
                            </label>
                            <input type="date" name="fecha_apertura_tecnica_publicacionportal" id="aperturaTecnicaInput" class="campoEtapa"  value="{{ licitacion.fecha_apertura_tecnica_publicacionportal|date:"Y-m-d"|default:'' }}">
                            </input>
                            <label for="aperturaEconomicaInput" class="campo-label">
                                <span class="field-icon"></span>
                                Apertura econ√≥mica
                            </label>
                            <input type="date" name="fecha_apertura_economica_publicacionportal" id="aperturaEconomicaInput" class="campoEtapa"  value="{{ licitacion.fecha_apertura_economica_publicacionportal|date:"Y-m-d"|default:'' }}">
                            </input>
                            <label for="fechaEstimadaAdjudicacionInput" class="campo-label">
                                <span class="field-icon"></span>
                                Fecha estimada de adjudicaci√≥n
                            </label>
                            <input type="date" name="fecha_estimada_adjudicacion_publicacionportal" id="fechaEstimadaAdjudicacionInput" class="campoEtapa"  value="{{ licitacion.fecha_estimada_adjudicacion_publicacionportal|date:"Y-m-d"|default:'' }}">
                            </input>
                        </div>

                        <div id="evaluacionOfertaContainer" class="evaluacion-oferta-container hidden" style="margin-bottom: 50px;">
                            <h3 class="section-title" style="cursor: pointer;">
                                <span class="section-icon"></span>
                                Tipo de solicitud:
                            </h3>
                            <select id="tipoSolicitudSelect" name="tipo_solicitud" class="campoEtapa" style="margin-bottom: 2vh;">
                                <option value="">Observaci√≥n corriente</option>
                                <option value="1">Fecha que se env√≠a evaluaci√≥n t√©cnica</option>
                                <option value="2">Comisi√≥n evaluadora</option>
                            </select>
                            <div class="evaluacion-tecnica campo-group hidden">
                                <h3 class="section-title" style="cursor: pointer;">
                                    <span class="section-icon">üìÖ</span>
                                    Fecha que se env√≠a evaluaci√≥n t√©cnica
                                </h3>
                                <input type="date" name="fecha_evaluacion_tecnica_evaluacion" id="fechaEvaluacionTecnicaInput" class="campoEtapa" value="{{ licitacion.fecha_evaluacion_tecnica_evaluacion|date:"Y-m-d"|default:'' }}">
                                </input>
                            </div>
                            <div class="comision-evaluadora campo-group hidden">
                                <h3 class="section-title" style="cursor: pointer;">
                                    <span class="section-icon">üìÖ</span>
                                    Comisi√≥n evaluadora
                                </h3>
                                <label for="nombreIntegranteUnoEvaluacionInput" class="campo-label">
                                    <span class="field-icono"></span>
                                    Integrante N¬∞ 1
                                </label>
                                <input type="text" name="nombre_integrante_uno_evaluacion" id="nombreIntegranteUnoEvaluacionInput" placeholder="Integrante N¬∞ 1" class="campoEtapa" value="{{ licitacion.nombre_integrante_uno_evaluacion|default:'' }}">
                                </input>
                                <label for="nombreIntegranteDosEvaluacionInput" class="campo-label">
                                    <span class="field-icono"></span>
                                    Integrante N¬∞ 2
                                </label>
                                <input type="text" name="nombre_integrante_dos_evaluacion" id="nombreIntegranteDosEvaluacionInput" placeholder="Integrante N¬∞ 2" class="campoEtapa" value="{{ licitacion.nombre_integrante_dos_evaluacion|default:'' }}">
                                </input>
                                <label for="nombreIntegranteTresEvaluacionInput" class="campo-label">
                                    <span class="field-icono"></span>
                                    Integrante N¬∞ 3
                                </label>
                                <input type="text" name="nombre_integrante_tres_evaluacion" id="nombreIntegranteTresEvaluacionInput" placeholder="Integrante N¬∞ 3" class="campoEtapa" value="{{ licitacion.nombre_integrante_tres_evaluacion|default:'' }}">
                                </input>
                                <label for="fechaComisionInput" class="campo-label">
                                    <span class="field-icon"></span>
                                    Fecha de comisi√≥n evaluadora
                                </label>
                                <input type="date" name="fecha_comision_evaluacion" id="fechaComisionInput" class="campoEtapa" value="{{ licitacion.fecha_comision_evaluacion|date:"Y-m-d"|default:'' }}">
                            </div>
                        </div>

                        <div id="solicitudRegimenInternoContainer" class="solicitud-regimen-interno-container hidden" style="margin-bottom: 50px;">
                            <h3 class="section-title" style="cursor: pointer;">
                                <span class="section-icon">üìÖ</span>
                                Fecha de solicitud de comisi√≥n de r√©gimen interno
                            </h3>
                            <input type="date" name="fecha_solicitud_regimen_interno" id="fechaSolicitudRegimenInternoInput" class="campoEtapa" value="{{ licitacion.fecha_solicitud_regimen_interno|date:"Y-m-d"|default:'' }}">
                            </input>
                        </div>

                        <div id="recepcionDocumentosRegimenInternoContainer" class="recepcion-documentos-regimen-interno-container hidden" style="margin-bottom: 50px;">
                            <h3 class="section-title" style="cursor: pointer;">
                                <span class="section-icon">üìÖ</span>
                                Fecha de recepci√≥n de documento de r√©gimen interno
                            </h3>
                            <input type="date" name="fecha_recepcion_documento_regimen_interno" id="fechaRecepcionDocumentoRegimenInternoInput" class="campoEtapa" value="{{ licitacion.fecha_recepcion_documento_regimen_interno|date:"Y-m-d"|default:'' }}">
                            </input>
                        </div>

                        <div id="adjudicacionContainer" class="adjudicacion-container hidden" style="margin-bottom: 50px;">
                            <div class="campo-grupo">
                                <label for="empresaNombreInput" class="campo-label">
                                    <span class="label-icono">üè¢</span>
                                    Nombre de Empresa:
                                </label>
                                <input 
                                    type="text" 
                                    id="empresaNombreInput" 
                                    name="empresa_adjudicacion" 
                                    class="campoEtapa"
                                    placeholder="Ej: Constructora ABC Ltda."
                                    maxlength="200"
                                    value="{{ licitacion.empresa_adjudicacion|default:'' }}"
                                >
                            </div>
                            
                            <div class="campo-grupo">
                                <label for="empresaRutInput" class="campo-label">
                                    <span class="label-icono">üÜî</span>
                                    RUT de Empresa:
                                </label>
                                <input 
                                    type="text" 
                                    id="empresaRutInput" 
                                    name="rut_adjudicacion" 
                                    class="campoEtapa"
                                    placeholder="Ej: 12.345.678-9"
                                    maxlength="12"
                                    value="{{ licitacion.rut_adjudicacion|default:'' }}"
                                >
                                <div class="campo-ayuda">
                                    <span class="ayuda-icono">üí°</span>
                                    <span class="ayuda-texto">RUT de la empresa adjudicataria o principal participante</span>
                                </div>
                            </div>
                            <div class="campo-grupo">
                                <label for="montoAdjudicadoInput" class="campo-label">
                                    <span class="label-icono">üí∞</span>
                                    Monto adjudicado:
                                </label>
                                <input 
                                    type="number" 
                                    step="0.01"
                                    id="montoAdjudicadoInput" 
                                    name="monto_adjudicacion" 
                                    class="campoEtapa"
                                    placeholder="Ej: 1500000.00"
                                    min="0"
                                    value="{{ licitacion.monto_adjudicacion|default:'' }}">
                                <div class="campo-ayuda">
                                    <span class="ayuda-icono">üí°</span>
                                    <span class="ayuda-texto">En pesos</span>
                                </div>
                            </div>
                            <div class="campo-grupo">
                                <label for="fechaDecretoInput" class="campo-label">
                                    <span class="label-icono">üìÖ</span>
                                    Fecha de decreto:
                                </label>
                                <input 
                                    type="date" 
                                    id="fechaDecretoInput" 
                                    name="fecha_decreto_adjudicacion" 
                                    class="campoEtapa"
                                    value="{{ licitacion.fecha_decreto_adjudicacion|date:"Y-m-d"|default:'' }}">
                            </div>
                            <div class="campo-grupo">
                                <label for="fechaSubidaMercadoPublicoInput" class="campo-label">
                                    <span class="label-icono">üìÖ</span>
                                    Fecha de subida a Mercado P√∫blico:
                                </label>
                                <input 
                                    type="date" 
                                    id="fechaSubidaMercadoPublicoInput" 
                                    name="fecha_subida_mercado_publico_adjudicacion" 
                                    class="campoEtapa"
                                    value="{{ licitacion.fecha_subida_mercado_publico_adjudicacion|date:"Y-m-d"|default:'' }}">
                            </div>
                            <div class="campo-grupo">
                                <label for="numeroOrdenCompraInput" class="campo-label">
                                    <span class="label-icono">üõí</span>
                                    N√∫mero de orden de compra:
                                </label>
                                <input 
                                    type="number" 
                                    id="numeroOrdenCompraInput" 
                                    name="orden_compra_adjudicacion" 
                                    class="campoEtapa"
                                    placeholder="Ej: 12345"
                                    max=999999999
                                    value="{{ licitacion.orden_compra_adjudicacion|default:'' }}">
                            </div>
                        </div>

                        <div id="disponibilidadPresupuestariaContainer" class="disponibilidad-presupuestaria-container hidden" style="margin-bottom: 50px;">
                            <h3 class="section-title" style="cursor: pointer;">
                                <span class="section-icon">üìÖ</span>
                                Fecha de disponibilidad presupuestaria
                            </h3>
                            <input type="date" name="fecha_disponibilidad_presupuestaria" id="fechaDisponibilidadPresupuestariaInput" class="campoEtapa" value="{{ licitacion.fecha_disponibilidad_presupuestaria|date:"Y-m-d"|default:'' }}">
                            </input>
                        </div>

                        <div id="topeFirmaContratoContainer" class="firma-contrato-container hidden" style="margin-bottom: 50px;">
                            <div class="campo-group" style="margin-bottom: 20px">
                                <h3 class="section-title" style="cursor: pointer;">
                                    <span class="section-icon">üìÖ</span>
                                    Fecha tope de firma de contrato
                                </h3>
                                <input type="date" name="fecha_tope_firma_contrato" id="fechaTopeFirmaContratoInput" class="campoEtapa" value="{{ licitacion.fecha_tope_firma_contrato|date:"Y-m-d"|default:'' }}">
                                </input>
                            </div>
                            <div class="campo-group">
                                <button type="button" id="btnModalRedestinar" class="btn-accion btn-primario">
                                    <span class="btn-icono">üîÑ</span>
                                    Redestinar
                                </button>
                            </div>
                        </div>

                        <div id="evaluacionCotizacionContainer" class="evaluacion-cotizacion-container hidden" style="margin-bottom: 50px;">
                            <h3 class="section-title" style="cursor: pointer;">
                                <span class="section-icon"></span>
                                Evaluaci√≥n de la cotizaci√≥n:
                            </h3>
                            <div class="campo-grupo">
                                <label for="fechaEvaluacionCotizacionInput" class="campo-label">
                                    <span class="label-icono">üìÖ</span>
                                    Fecha de evaluaci√≥n:
                                </label>
                                <input 
                                    type="date" 
                                    id="fechaEvaluacionCotizacionInput" 
                                    name="fecha_evaluacion_cotizacion" 
                                    class="campoEtapa"
                                    value="{{ licitacion.fecha_evaluacion_cotizacion|date:"Y-m-d"|default:'' }}">
                            </div>
                            <div class="campo-grupo">
                                <label for="montoEstimadoCotizacionInput" class="campo-label">
                                    <span class="label-icono">üí∞</span>
                                    Monto estimado:
                                </label>
                                <input 
                                    type="number" 
                                    step="0.01"
                                    id="montoEstimadoCotizacionInput" 
                                    name="monto_estimado_cotizacion" 
                                    class="campoEtapa"
                                    placeholder="Ej: 1500000.00"
                                    min="0"
                                    value="{{ licitacion.monto_estimado_cotizacion|default:'' }}">
                                <div class="campo-ayuda">
                                    <span class="ayuda-icono">üí°</span>
                                    <span class="ayuda-texto">En pesos</span>
                                </div>
                            </div>
                        </div>

                        <div id="decretoIntencionCompraContainer" class="decreto-intencion-compra-container hidden" style="margin-bottom: 50px;">
                            <div class="campo-grupo">
                                <label for="fechaSolicitudIntencionCompraInput" class="campo-label">
                                    <span class="label-icono">üìÖ</span>
                                    Fecha de decreto:
                                </label>
                                <input 
                                    type="date" 
                                    id="fechaSolicitudIntencionCompraInput" 
                                    name="fecha_solicitud_intencion_compra" 
                                    class="campoEtapa"
                                    value="{{ licitacion.fecha_solicitud_intencion_compra|date:"Y-m-d"|default:'' }}">
                            </div>
                        </div>

                        <div id="comisionBaseContainer" class="comision-base-container hidden" style="margin-bottom: 50px;">
                            <h3 class="section-title" style="cursor: pointer;">
                                <span class="section-icon"></span>
                                Comision de base:
                            </h3>
                            <label for="nombreIntegranteUnoComisionBaseInput" class="campo-label">
                                <span class="field-icono"></span>
                                Integrante N¬∞ 1
                            </label>
                            <input type="text" name="nombre_integrante_uno_comision_base" id="nombreIntegranteUnoComisionBaseInput" placeholder="Integrante N¬∞ 1" class="campoEtapa" value="{{ licitacion.nombre_integrante_uno_comision_base|default:'' }}">
                            </input>
                            <label for="nombreIntegranteDosComisionBaseInput" class="campo-label">
                                <span class="field-icono"></span>
                                Integrante N¬∞ 2
                            </label>
                            <input type="text" name="nombre_integrante_dos_comision_base" id="nombreIntegranteDosComisionBaseInput" placeholder="Integrante N¬∞ 2" class="campoEtapa" value="{{ licitacion.nombre_integrante_dos_comision_base|default:'' }}">
                            </input>
                            <label for="nombreIntegranteTresComisionBaseInput" class="campo-label">
                                <span class="field-icono"></span>
                                Integrante N¬∞ 3
                            </label>
                            <input type="text" name="nombre_integrante_tres_comision_base" id="nombreIntegranteTresComisionBaseInput" placeholder="Integrante N¬∞ 3" class="campoEtapa" value="{{ licitacion.nombre_integrante_tres_comision_base|default:'' }}">
                            </input>
                        </div>

                        <div id="publicacionMercadoPublicoContainer" class="publicacion-mercado-publico-container hidden" style="margin-bottom: 50px;">
                            <h3 class="section-title" style="cursor: pointer;">
                                <span class="section-icon"></span>
                                Fechas de mercado p√∫blico:
                            </h3>
                            <div class="campo-grupo">
                                <label for="fechaPublicacionMercadoPublicoInput" class="campo-label">
                                    <span class="label-icono">üìÖ</span>
                                    Fecha de publicaci√≥n:
                                </label>
                                <input 
                                    type="date" 
                                    id="fechaPublicacionMercadoPublicoInput" 
                                    name="fecha_publicacion_mercado_publico" 
                                    class="campoEtapa"
                                    value="{{ licitacion.fecha_publicacion_mercado_publico|date:"Y-m-d"|default:'' }}">
                            </div>
                            <div class="campo-grupo">
                                <label for="fechaCierreOfertasMercadoPublicoInput" class="campo-label">
                                    <span class="label-icono">üìÖ</span>
                                    Fecha de cierre de ofertas:
                                </label>
                                <input 
                                    type="date" 
                                    id="fechaCierreOfertasMercadoPublicoInput" 
                                    name="fecha_cierre_ofertas_mercado_publico" 
                                    class="campoEtapa"
                                    value="{{ licitacion.fecha_cierre_ofertas_mercado_publico|date:"Y-m-d"|default:'' }}">
                            </div>
                        </div>
                        <!-- Campo ID Mercado P√∫blico - se muestra solo en etapa "Publicacion en portal" -->
                        <div id="idMercadoPublicoContainer" class="id-mercado-publico-container hidden">
                            <label for="idMercadoPublicoInput" class="campo-label">
                                <span class="label-icono">üèõÔ∏è</span>
                                ID Mercado P√∫blico:
                            </label>
                            <input 
                                type="text" 
                                id="idMercadoPublicoInput" 
                                name="id_mercado_publico" 
                                class="campoEtapa"
                                placeholder="(ej: 1234-56-LQ21)"
                                maxlength="50"
                                value="{{ licitacion.id_mercado_publico|default:'' }}"
                            >
                            <div class="campo-ayuda">
                                <span class="ayuda-icono">üí°</span>
                                <span class="ayuda-texto">ID √∫nico asignado por el portal de mercado p√∫blico</span>
                            </div>
                        </div>
                        
                        <!-- Campo de observaci√≥n -->
                        <div class="observacion-campo">
                            <label for="observacionTexto" class="campo-label">
                                <span class="label-icono">üí≠</span>
                                Observaci√≥n:
                            </label>
                            <textarea 
                                id="observacionTexto" 
                                name="texto" 
                                rows="4" 
                                class="observacion-textarea"
                                placeholder="Describe aqu√≠ los avances, comentarios o situaciones relevantes de la licitaci√≥n..."
                                required></textarea>
                        </div>
                        
                        <!-- Campo de archivos -->
                        <div class="archivos-campo">
                            <label class="campo-label">
                                <span class="label-icono">üìé</span>
                                Archivos adjuntos:
                            </label>
                            <div class="dropzone-bitacora" id="dropzoneBitacora">
                                <div class="dropzone-contenido">
                                    <span class="dropzone-icono">üìÅ</span>
                                    <span class="dropzone-texto">Arrastra archivos aqu√≠ o haz clic para seleccionar</span>
                                </div>
                                <input type="file" id="observacionArchivos" name="archivos" multiple class="file-input-hidden">
                            </div>
                            <div id="previewArchivosBitacora" class="preview-archivos"></div>
                        </div>
                        
                        <!-- Opciones adicionales -->
                        <div class="opciones-adicionales">
                            <div class="opcion-item">
                                <input type="checkbox" id="marcarFallidaCheckbox" name="marcar_fallida" class="opcion-checkbox">
                                <label for="marcarFallidaCheckbox" class="opcion-label opcion-fallida">
                                    <span class="opcion-icono">‚ö†Ô∏è</span>
                                    Marcar licitaci√≥n como <strong>FALLIDA</strong>
                                </label>
                            </div>
                            
                            <!-- Tipo de falla - se muestra solo si est√° marcado como fallida -->
                            <div id="tipoFallidaContainer" class="tipo-falla-container hidden">
                                <label for="tipoFallidaSelect" class="campo-label">
                                    <span class="label-icono">üîç</span>
                                    Tipo de falla:
                                </label>
                                <select id="tipoFallidaSelect" name="tipo_fallida" class="tipo-falla-select">
                                    <option value="">Selecciona un tipo de falla</option>
                                    <option value="revocada">üö´ Revocada</option>
                                    <option value="anulada">‚ùå Anulada</option>
                                    <option value="desierta">üìã Desierta</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Botones de acci√≥n -->
                        <div class="panel-acciones">
                            <button type="button" id="btnLimpiarObservacion" class="btn-accion btn-secundario">
                                <span class="btn-icono">üßπ</span>
                                Limpiar
                            </button>
                            <button type="submit" id="btnEnviarObservacion" class="btn-accion btn-primario">
                                <span class="btn-icono">üíæ</span>
                                Guardar Observaci√≥n
                            </button>
                        </div>
                    </form>
                </div>
            </div>
           
            {% endif %}

            <div class="bitacora-entradas">
                {% for b in bitacoras %}
                <div class="bitacora-entrada">
                    <div class="entrada-fecha">
                        <div class="fecha-dia">{{ b.fecha|date:"d" }}</div>
                        <div class="fecha-mes">{{ b.fecha|date:"M" }}</div>
                        <div class="fecha-ano">{{ b.fecha|date:"Y" }}</div>
                        <div class="fecha-hora">{{ b.fecha|date:"H:i" }}</div>
                    </div>
                    
                    <div class="entrada-contenido">
                        <div class="entrada-header">
                            <div class="entrada-operador">
                                <span class="operador-icono">üë§</span>
                                <span class="operador-nombre">
                                    {% if b.operador_user %}
                                        {{ b.operador_user.get_full_name|default:b.operador_user.username }}
                                    {% elif 'admin' in b.texto|lower %}
                                        Administrador
                                    {% elif licitacion.operador_user %}
                                        {{ licitacion.operador_user.get_full_name|default:licitacion.operador_user.username }}
                                    {% else %}Sistema{% endif %}
                                </span>
                            </div>
                            
                            {% if b.etapa %}
                            <div class="entrada-etapa">
                                <span class="etapa-icono">üéØ</span>
                                <span class="etapa-nombre">{{ b.etapa.nombre }}</span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="entrada-texto">
                            {{ b.texto|linebreaksbr }}
                        </div>
                        
                        {% if b.archivos.all %}
                        <div class="entrada-archivos">
                            <div class="archivos-titulo">üìé Archivos adjuntos:</div>
                            <div class="archivos-lista">
                                {% for doc in b.archivos.all %}
                                <div class="archivo-item">
                                    <span class="archivo-icono">üìÑ</span>
                                    <span class="archivo-nombre">{{ doc.nombre|default:doc.archivo.name|cut:'documentos_licitacion/' }}</span>
                                    <div class="archivo-acciones">
                                        <a href="{{ doc.archivo.url }}" target="_blank" class="archivo-btn archivo-ver" title="Ver">üëÅÔ∏è</a>
                                        <a href="{{ doc.archivo.url }}" target="_blank" class="archivo-btn archivo-descargar" title="Descargar">‚¨áÔ∏è</a>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if b.observacion or es_admin %}
                        <div class="entrada-observaciones">
                            {% if b.observacion %}
                            <div class="observacion-contenido">
                                <div class="observacion-titulo">üí≠ Observaci√≥n:</div>
                                <div class="observacion-texto">{{ b.observacion.texto }}</div>
                                {% if es_admin %}
                                <div class="observacion-acciones">
                                    <button class="btn-emoji editar-observacion-mini" data-id="{{ b.id }}" title="Editar observaci√≥n">‚úèÔ∏è</button>
                                    <button class="btn-emoji eliminar-observacion-mini" data-id="{{ b.id }}" title="Eliminar observaci√≥n">üóëÔ∏è</button>
                                </div>
                                {% endif %}
                            </div>
                            {% else %}
                                {% if es_admin and licitacion.estado_fk.nombre == 'En Curso' %}
                                <button class="btn-agregar-observacion-bitacora" data-id="{{ b.id }}">
                                    üí≠ Agregar observaci√≥n
                                </button>
                                {% endif %}
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        {% if es_admin %}
                        <div class="entrada-admin">
                            <button class="btn-eliminar-entrada" data-id="{{ b.id }}" title="Eliminar entrada">
                                üóëÔ∏è Eliminar entrada
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <div class="bitacora-vacia">
                    <div class="vacia-icono">üìù</div>
                    <div class="vacia-texto">A√∫n no hay entradas en esta bit√°cora</div>
                    <div class="vacia-subtexto">Las acciones y observaciones aparecer√°n aqu√≠</div>
                </div>
                {% endfor %}
            </div>            </div>
            
            {% if paginator.num_pages > 1 %}
            <div class="bitacora-paginacion">
                <div class="paginacion-info">
                    Mostrando entradas {{ bitacoras.start_index }} - {{ bitacoras.end_index }} de {{ paginator.count }} total
                </div>
                <div class="paginacion-controles">
                    {% if bitacoras.has_previous %}
                        <a href="?page={{ bitacoras.previous_page_number }}" class="paginacion-btn paginacion-prev">
                            ‚¨ÖÔ∏è Anteriores
                        </a>
                    {% endif %}
                    
                    <div class="paginacion-numeros">
                        {% for num in paginator.page_range %}
                            {% if bitacoras.number == num %}
                                <span class="paginacion-numero paginacion-actual">{{ num }}</span>
                            {% elif num > bitacoras.number|add:'-3' and num < bitacoras.number|add:'3' %}
                                <a href="?page={{ num }}" class="paginacion-numero">{{ num }}</a>
                            {% endif %}
                        {% endfor %}
                    </div>
                    
                    {% if bitacoras.has_next %}
                        <a href="?page={{ bitacoras.next_page_number }}" class="paginacion-btn paginacion-next">
                            Siguientes ‚û°Ô∏è
                        </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <div class="bitacora-footer">
                {% if es_admin %}
                    <a href="{% url 'vista_admin' %}" class="btn-volver">‚¨ÖÔ∏è Volver al Panel Admin</a>
                {% elif es_operador_manual %}
                    <a href="{% url 'vista_operador_manual' %}" class="btn-volver">‚¨ÖÔ∏è Volver al Panel Operador</a>
                {% elif es_operador %}
                    <a href="{% url 'vista_operador' %}" class="btn-volver">‚¨ÖÔ∏è Volver al Panel Operador</a>
                {% else %}
                    <a href="/" class="btn-volver">‚¨ÖÔ∏è Volver</a>
                {% endif %}
            </div>
        </div>
        {{ etapas|json_script:"etapas-licitacion-data" }}
        <script>
            window.etapasLicitacion = JSON.parse(document.getElementById('etapas-licitacion-data').textContent);
        </script>n 
        <script src="{% static 'licitaciones/js/bitacora_licitacion.js' %}" defer></script>
    </div>

    <div class="modal-container" id="modalRedestinar">
        <div class="modal-content" style="padding: 20px 20px;">
            <span id="cerrarModalRedestinar" class="btn-close">&times;</span>
            <h2 id="tituloModalRedestinar">Redestinaci√≥n</h2>
            <form id="formModalRedestinar" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="licitacion_id" value="{{ licitacion.id }}">
                <div class="modal-field-container">
                    <label for="modalRedestinarTexto" class="modal-field-label">Raz√≥n:</label>
                    <textarea id="modalRedestinarTexto" name="texto" rows="4" class="modal-textarea" placeholder="Escribe la raz√≥n de redestinaci√≥n..."></textarea>
                </div>
                <!-- Informaci√≥n de ayuda -->
                <div class="modal-file-help">
                    <span class="help-icon">üí°</span>
                    <span class="help-text">Se redestinar√° la licitacion a "Evaluaci√≥n de ofertas" y se registrar√° en la bit√°cora</span>
                </div>

                <div class="modal-buttons">
                    <button type="button" id="btnCancelarRedestinar">Cancelar</button>
                    <button type="submit" id="btnRedestinar">üîÑ Redestinar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para agregar/editar observaci√≥n -->
    <div class="modal-container" id="modalObservacion">
        <div class="modal-content" style="padding: 20px 20px;">
            <span id="cerrarModalObservacion" class="btn-close">&times;</span>
            <h2 id="tituloModalObservacion">üí≠ Observaci√≥n</h2>
            <form id="formModalObservacion" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="bitacora_id" id="observacionBitacoraId">
                
                <div class="modal-field-container">
                    <label for="modalObservacionTexto" class="modal-field-label">Observaci√≥n:</label>
                    <textarea id="modalObservacionTexto" name="texto" rows="4" class="modal-textarea" required {% if not es_admin %}readonly{% endif %} placeholder="Escribe tu observaci√≥n aqu√≠..."></textarea>
                </div>
                
                <!-- Secci√≥n de archivos adjuntos en el modal -->
                {% if es_admin %}
                <div class="modal-field-container">
                    <label class="modal-field-label">
                        <span class="modal-label-icon">üìé</span>
                        Archivos adjuntos:
                    </label>
                    
                    <!-- Dropzone mejorada para el modal -->
                    <div class="modal-dropzone" id="modalDropzone">
                        <div class="modal-dropzone-content">
                            <div class="modal-dropzone-icon">üìÅ</div>
                            <div class="modal-dropzone-text">
                                <div class="modal-dropzone-main">Arrastra archivos aqu√≠</div>
                                <div class="modal-dropzone-sub">o haz clic para seleccionar</div>
                            </div>
                            <label class="modal-dropzone-button" for="modalArchivos">
                                <span class="modal-btn-icon">üìé</span>
                                Seleccionar archivos
                            </label>
                        </div>
                        <input type="file" id="modalArchivos" name="archivos" multiple class="file-input-hidden" accept="*/*">
                    </div>
                    
                    <!-- Vista previa de archivos del modal -->
                    <div id="modalPreviewArchivos" class="modal-preview-archivos"></div>
                    
                    <!-- Informaci√≥n de ayuda -->
                    <div class="modal-file-help">
                        <span class="help-icon">üí°</span>
                        <span class="help-text">Puedes seleccionar m√∫ltiples archivos. Tipos soportados: documentos, im√°genes, PDF, etc.</span>
                    </div>
                </div>
                {% endif %}
                
                <div class="modal-buttons">
                    <button type="button" id="btnCancelarObservacion">Cancelar</button>
                    {% if es_admin %}
                    <button type="submit" id="btnGuardarObservacion">üíæ Guardar</button>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
</body>
</html>
