{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Calendario de Actividad - Sistema de Licitaciones</title>
    <link rel="stylesheet" href="{% static 'licitaciones/css/gestion_licitaciones_v1.css' %}?v=2.0">
    <link rel="stylesheet" href="{% static 'licitaciones/css/calendario_actividad_v1.css' %}?v=1.0">
</head>
<body>
    {% include 'licitaciones/sidebar.html' %}
    <div class="main-content m-sidebar">
        <div class="calendario-header">
            <h1 class="titulo" style="color: white;">üìÖ Calendario de Actividad</h1>
            <p class="calendario-descripcion">Visualiza la actividad diaria del sistema de licitaciones</p>
        </div>
        
        <div class="calendario-controles">
    <div class="filtros-fecha">

        <div class="filtro-grupo">
            <label for="selectA√±o">A√±o:</label>
            <select id="selectA√±o" class="filtro-select">
                {# 1. A√±os anteriores disponibles (Historial) #}
                {% for a√±o in a√±os_disponibles %}
                    {% if a√±o < a√±o_actual %}
                        <option value="{{ a√±o }}">{{ a√±o }}</option>
                    {% endif %}
                {% endfor %}

                {# 2. A√±o Actual (Siempre visible y SELECCIONADO por defecto) #}
                <option value="{{ a√±o_actual }}" selected>{{ a√±o_actual }}</option>

                {# 3. A√±o Siguiente (Siempre disponible) #}
                <option value="{{ a√±o_actual|add:'1' }}">{{ a√±o_actual|add:'1' }}</option>
            </select>
        </div>
        <div class="filtro-grupo">
            <label for="selectMes">Mes:</label>
            <select id="selectMes" class="filtro-select">
                        <option value="">Todos los meses</option>
                        <option value="1" {% if mes_actual == 1 %}selected{% endif %}>Enero</option>
                        <option value="2" {% if mes_actual == 2 %}selected{% endif %}>Febrero</option>
                        <option value="3" {% if mes_actual == 3 %}selected{% endif %}>Marzo</option>
                        <option value="4" {% if mes_actual == 4 %}selected{% endif %}>Abril</option>
                        <option value="5" {% if mes_actual == 5 %}selected{% endif %}>Mayo</option>
                        <option value="6" {% if mes_actual == 6 %}selected{% endif %}>Junio</option>
                        <option value="7" {% if mes_actual == 7 %}selected{% endif %}>Julio</option>
                        <option value="8" {% if mes_actual == 8 %}selected{% endif %}>Agosto</option>
                        <option value="9" {% if mes_actual == 9 %}selected{% endif %}>Septiembre</option>
                        <option value="10" {% if mes_actual == 10 %}selected{% endif %}>Octubre</option>
                        <option value="11" {% if mes_actual == 11 %}selected{% endif %}>Noviembre</option>
                        <option value="12" {% if mes_actual == 12 %}selected{% endif %}>Diciembre</option>
                    </select>
                </div>
                <div class="navegacion-mes">
                    <button id="btnMesAnterior" class="btn btn-nav">‚óÄ Anterior</button>
                    <button id="btnMesSiguiente" class="btn btn-nav">Siguiente ‚ñ∂</button>
                </div>
                <button id="btnFiltrar" class="btn-primary">üîç Filtrar</button>
                <button id="btnHoy" class="btn-secondary">üìç Hoy</button>
            </div>
            
            <div class="vista-controles">
                <button id="btnVistaCalendario" class="btn btn-vista active">üìÖ Vista Calendario</button>
                <button id="btnVistaLista" class="btn btn-vista">üìã Vista Lista</button>
            </div>
        </div>
        
        <div class="leyenda-eventos">
            <h3>Leyenda de Eventos:</h3>
            <div class="leyenda-items">
                <div class="leyenda-item">
                    <span class="leyenda-color"></span>
                    <span>‚ùì Cierre Preguntas Portal</span>
                </div>

                <div class="leyenda-item">
                    <span class="leyenda-color" ></span>
                    <span>üí¨ Respuestas Portal</span>
                </div>

                <div class="leyenda-item">
                    <span class="leyenda-color"></span>
                    <span>üõë Cierre Ofertas Portal</span>
                </div>

                <div class="leyenda-item">
                    <span class="leyenda-color" ></span>
                    <span>üèÜ Est. Adjudicaci√≥n</span>
                </div>

                <div class="leyenda-item">
                    <span class="leyenda-color" ></span>
                    <span>üõí Cierre Ofertas MP</span>
                </div>

                <div class="leyenda-item">
                    <span class="leyenda-color" ></span>
                    <span>‚úçÔ∏è Tope Firma Contrato</span>
                </div>
            </div>
        </div>
        
        <!-- Vista Calendario -->
        <div id="vistaCalendario" class="vista-calendario">
            <div id="calendarioContainer" class="calendario-container">
                <div class="calendario-cargando">
                    <div class="spinner"></div>
                    <p>Cargando calendario...</p>
                </div>
            </div>
        </div>
        
        <!-- Vista Lista -->
        <div id="vistaLista" class="vista-lista" style="display: none;">
            <div class="eventos-estadisticas">
                <div class="estadistica-card">
                    <div class="estadistica-numero" id="totalEventos">0</div>
                    <div class="estadistica-label">Total de Eventos</div>
                </div>
                <div class="estadistica-card">
                    <div class="estadistica-numero" id="totalCreaciones">0</div>
                    <div class="estadistica-label">Licitaciones Creadas</div>
                </div>
                <div class="estadistica-card">
                    <div class="estadistica-numero" id="totalCambiosEtapa">0</div>
                    <div class="estadistica-label">Cambios de Etapa</div>
                </div>
                <div class="estadistica-card">
                    <div class="estadistica-numero" id="totalObservaciones">0</div>
                    <div class="estadistica-label">Observaciones</div>
                </div>
            </div>
            
            <div class="eventos-filtros">
                <input type="text" id="buscarEventos" class="form-control" placeholder="üîç Buscar eventos...">
                <select id="filtroTipoEvento" class="form-control">
                    <option value="">Todos los tipos</option>
                    <option value="creacion">Creaci√≥n de licitaciones</option>
                    <option value="cambio_etapa">Cambios de etapa</option>
                    <option value="observacion">Observaciones</option>
                    <option value="cierre">Cierres/Fallos</option>
                </select>
            </div>
            
            <div id="listaEventos" class="lista-eventos">
                <div class="eventos-cargando">
                    <div class="spinner"></div>
                    <p>Cargando eventos...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para detalles del evento -->
    <div id="modalEvento" class="modal-container" style="display: none;">
        <div class="modal-content modal-evento">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="modal-icon" id="eventoIcono">üìÖ</span>
                    <span class="modal-title-text" id="eventoTitulo">Detalles del Evento</span>
                </h2>
                <div class="btn-close" id="cerrarModalEvento">&times;</div>
            </div>
            
            <div class="modal-body">
                <div class="evento-info">
                    <div class="info-row">
                        <div class="info-label">Fecha y Hora:</div>
                        <div class="info-value" id="eventoFechaHora">-</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Tipo:</div>
                        <div class="info-value" id="eventoTipo">-</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Operador:</div>
                        <div class="info-value" id="eventoOperador">-</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Descripci√≥n:</div>
                        <div class="info-value" id="eventoDescripcion">-</div>
                    </div>
                    <div class="info-row" id="eventoEtapaRow" style="display: none;">
                        <div class="info-label">Etapa:</div>
                        <div class="info-value" id="eventoEtapa">-</div>
                    </div>
                </div>
                
                <div class="evento-acciones">
                    <button id="btnVerLicitacion" class="btn btn-primary">
                        <span class="btn-icon">üè¢</span>
                        Ver Licitaci√≥n
                    </button>
                    <button id="btnVerBitacora" class="btn btn-secondary">
                        <span class="btn-icon">üìí</span>
                        Ver Bit√°cora
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
(function() {
    console.log("üõ†Ô∏è Sistema de Calendario: Modo Dual Activado");

    window.cerrarMiModal = function() {
        const modal = document.getElementById('miModalGenerado');
        if (modal) modal.remove();
    };

    // Funci√≥n para mostrar el detalle de UN evento (tu modal actual)
    window.mostrarModalEvento = function(datos) {
        cerrarMiModal();
        let nombreIniciativa = "";
        if (datos.descripcion) {
            const lineas = datos.descripcion.split('\n');
            const lineaIni = lineas.find(l => l.toLowerCase().includes('iniciativa:'));
            nombreIniciativa = lineaIni ? lineaIni.replace(/iniciativa:/i, '').trim() : "";
        }
        if (!nombreIniciativa) nombreIniciativa = datos.titulo || "";

        const urlBusqueda = '/administracion/?q=' + encodeURIComponent(nombreIniciativa).replace(/%20/g, '+');
        const descLimpia = (datos.descripcion || '').replace(/Licitaci√≥n:\s*[\d\w-]+\s*(\n)?/gi, '').trim();

        const modalDiv = document.createElement('div');
        modalDiv.id = 'miModalGenerado';
        modalDiv.style.cssText = `position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:100000; display:flex; align-items:center; justify-content:center; font-family:sans-serif;`;
        
        modalDiv.innerHTML = `
            <div style="background:white; width:90%; max-width:500px; border-radius:10px; padding:25px; position:relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
                <span onclick="cerrarMiModal()" style="position:absolute; top:10px; right:15px; font-size:30px; cursor:pointer; color:#999;">&times;</span>
                <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px; color:#333;">${datos.titulo}</h3>
                <div style="margin:15px 0; font-size:14px; color:#444; line-height:1.5; white-space:pre-wrap;">${descLimpia}</div>
                <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
                    <button onclick="window.location.href='${urlBusqueda}'" style="background:#007bff; color:white; border:none; padding:10px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">üîç Licitaci√≥n</button>
                    <button onclick="window.location.href='/bitacora/${datos.licitacion_id}/'" style="background:#28a745; color:white; border:none; padding:10px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">üìù Bit√°cora</button>
                </div>
            </div>
        `;
        modalDiv.onclick = function(e) { if(e.target === modalDiv) cerrarMiModal(); };
        document.body.appendChild(modalDiv);
    };

    // NUEVA: Funci√≥n para mostrar la lista de eventos del d√≠a
    window.mostrarListaDia = function(eventosDelDia, fechaTexto) {
        cerrarMiModal();
        const modalDiv = document.createElement('div');
        modalDiv.id = 'miModalGenerado';
        modalDiv.style.cssText = `position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:100000; display:flex; align-items:center; justify-content:center; font-family:sans-serif;`;

        let listaHTML = eventosDelDia.map(ev => {
            const d = JSON.parse(decodeURIComponent(ev.getAttribute('data-evento')));
            // Determinar color seg√∫n el tipo (opcional)
            let color = ev.style.backgroundColor || '#007bff';
            return `
                <div class="item-lista-dia" onclick='mostrarModalEvento(${JSON.stringify(d)})' 
                     style="padding:12px; margin-bottom:10px; border-left:5px solid ${color}; background:#f9f9f9; cursor:pointer; border-radius:4px; transition: 0.2s; hover:background:#eee;">
                    <div style="font-weight:bold; color:#333;">${d.titulo}</div>
                    <div style="font-size:12px; color:#666;">${d.operador || 'Sistema'}</div>
                </div>
            `;
        }).join('');

        modalDiv.innerHTML = `
            <div style="background:white; width:95%; max-width:400px; border-radius:10px; padding:20px; position:relative;">
                <span onclick="cerrarMiModal()" style="position:absolute; top:10px; right:15px; font-size:30px; cursor:pointer; color:#999;">&times;</span>
                <h3 style="margin-top:0; margin-bottom:15px; font-size:18px; color:#555;">Actividades del d√≠a</h3>
                <div style="max-height:400px; overflow-y:auto;">
                    ${listaHTML || '<p style="color:#888;">No hay eventos para este d√≠a.</p>'}
                </div>
            </div>
        `;
        modalDiv.onclick = function(e) { if(e.target === modalDiv) cerrarMiModal(); };
        document.body.appendChild(modalDiv);
    };

    // 3. CAPTURA DE CLICS INTELIGENTE
    document.addEventListener('click', function(e) {
        // Caso A: Clic en un evento espec√≠fico
        const itemEvento = e.target.closest('.evento-item');
        if (itemEvento) {
            e.preventDefault(); e.stopPropagation();
            const rawData = itemEvento.getAttribute('data-evento');
            if (rawData) mostrarModalEvento(JSON.parse(decodeURIComponent(rawData)));
            return;
        }

        // Caso B: Clic en el cuadro del d√≠a (celda del calendario)
        // Ajustamos '.fc-daygrid-day' o '.calendario-dia' seg√∫n la clase que use tu calendario
        const celdaDia = e.target.closest('.fc-daygrid-day, .calendario-dia, td');
        if (celdaDia) {
            const eventos = Array.from(celdaDia.querySelectorAll('.evento-item'));
            if (eventos.length > 0) {
                e.preventDefault(); e.stopPropagation();
                mostrarListaDia(eventos);
            }
        }
    }, true);

})();

    
</script>
    {% csrf_token %}

    <script src="{% static 'licitaciones/js/calendario_actividad_v1.js' %}?v=1.0"></script>
    
</body>
</html>
